name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

env:
  GO_VERSION: "1.25.6"

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.14.1

      - name: Create zig CC wrapper scripts
        run: |
          create_wrapper() {
            local name="$1" target="$2" tool="$3"
            cat > "/usr/local/bin/${name}" <<WRAPPER
          #!/bin/sh
          exec zig ${tool} -target ${target} "\$@"
          WRAPPER
            chmod +x "/usr/local/bin/${name}"
          }

          create_wrapper zigcc-linux-amd64   x86_64-linux-gnu   cc
          create_wrapper zigcpp-linux-amd64  x86_64-linux-gnu   c++
          create_wrapper zigcc-linux-arm64   aarch64-linux-gnu  cc
          create_wrapper zigcpp-linux-arm64  aarch64-linux-gnu  c++
          create_wrapper zigcc-darwin-amd64  x86_64-macos       cc
          create_wrapper zigcpp-darwin-amd64 x86_64-macos       c++
          create_wrapper zigcc-darwin-arm64  aarch64-macos      cc
          create_wrapper zigcpp-darwin-arm64 aarch64-macos      c++

      - name: Run tests
        run: go test -v -race -short ./...
        env:
          CGO_ENABLED: 1

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}

  release-windows:
    name: Build Windows Binary
    runs-on: windows-latest
    needs: release

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Extract version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Build Windows binary
        shell: bash
        env:
          CGO_ENABLED: "1"
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_TIME=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          go build \
            -ldflags "-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.buildTime=${BUILD_TIME}" \
            -o rift.exe ./cmd/rift

      - name: Create archive
        shell: bash
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          ARCHIVE="rift_${VERSION}_windows_amd64.zip"
          7z a "${ARCHIVE}" rift.exe README.md LICENSE CHANGELOG.md
          echo "ARCHIVE=${ARCHIVE}" >> "${GITHUB_ENV}"

      - name: Upload to release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: gh release upload "${TAG}" "${ARCHIVE}" --clobber

  npm-publish:
    name: Publish npm Packages
    runs-on: ubuntu-latest
    needs: [ release, release-windows ]
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Download release archives
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          REPO: ${{ github.repository }}
        run: |
          mkdir -p /tmp/release-assets
          gh release download "v${VERSION}" \
            --repo "${REPO}" \
            --pattern "rift_${VERSION}_*.tar.gz" \
            --pattern "rift_${VERSION}_*.zip" \
            --dir /tmp/release-assets

      - name: Prepare platform packages
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          prepare_package() {
            local goreleaser_key="$1" npm_suffix="$2" ext="$3"
            local pkg_dir="npm/cli-${npm_suffix}"
            local archive="rift_${VERSION}_${goreleaser_key}.${ext}"

            echo "Preparing @rift-data/cli-${npm_suffix} from ${archive}"
            mkdir -p "${pkg_dir}/bin"

            if [[ "${ext}" == "zip" ]]; then
              unzip -o "/tmp/release-assets/${archive}" "rift.exe" -d "${pkg_dir}/bin/"
            else
              tar -xzf "/tmp/release-assets/${archive}" -C "${pkg_dir}/bin/" rift
            fi

            cd "${pkg_dir}"
            npm version "${VERSION}" --no-git-tag-version --allow-same-version
            cd -
          }

          prepare_package darwin_amd64 darwin-x64 tar.gz
          prepare_package darwin_arm64 darwin-arm64 tar.gz
          prepare_package linux_amd64 linux-x64 tar.gz
          prepare_package linux_arm64 linux-arm64 tar.gz
          prepare_package windows_amd64 win32-x64 zip

      - name: Stamp main package version
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = process.env.VERSION;
            for (const dep of Object.keys(pkg.optionalDependencies || {})) {
              pkg.optionalDependencies[dep] = process.env.VERSION;
            }
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for dir in npm/cli-*/; do
            echo "Publishing $(basename "${dir}")..."
            cd "${dir}"
            npm publish --access public
            cd -
          done

      - name: Wait for registry propagation
        run: sleep 30

      - name: Publish main package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          TAG="latest"
          if [[ "${TAG_NAME}" == *"-"* ]]; then
            TAG="next"
          fi
          npm publish --access public --tag "${TAG}"

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [ release, release-windows, npm-publish ]

    steps:
      - name: Post release announcement
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          echo "Release ${TAG_NAME} published!"
